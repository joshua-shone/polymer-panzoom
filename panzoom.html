<link rel="import" href="/polymer/polymer.html">

<script>
  window.Yarnball = window.Yarnball || {};
  
  window.Yarnball.PanzoomBehavior = {
    _panzoomTranslate: {x: 0, y: 0},
    _panzoomScale: 1.0,
    ready: function() {
      this.style['transform-origin'] = '0 0';
    },
    panzoom: function(options) {
      this._panzoomTranslate = options.translate || this._panzoomTranslate;
      this._panzoomScale     = options.scale     || this._panzoomScale;
      this.style.transform = 'scale(' + this._panzoomScale + ') translate(' + this._panzoomTranslate.x + 'px, ' + this._panzoomTranslate.y + 'px)';
    },
    panOffset: function(offset) {
      this.panzoom({
        translate: {
          x: this._panzoomTranslate.x + offset.x,
          y: this._panzoomTranslate.y + offset.y,
        }
      });
    },
    zoomOffset: function(offset) {
      this.panzoom({
        scale: this._panzoomScale * (1.0 + offset),
      });
    },
    panzoomTowardPosition: function(position, zoomOffset) {
      if (!(position.transformed || position.untransformed)) {
        throw 'Cannot panzoom toward position, not given either transformed or untransformed position.';
      }
      if (!position.transformed) {
        position.transformed = this.panzoomTransformPoint(position.untransformed);
      }
      
      var descaledPosition = {
        x: position.transformed.x / this._panzoomScale,
        y: position.transformed.y / this._panzoomScale,
      }
      this.panzoom({
        translate: {
          x: this._panzoomTranslate.x - (descaledPosition.x - (descaledPosition.x / (1.0 + zoomOffset))),
          y: this._panzoomTranslate.y - (descaledPosition.y - (descaledPosition.y / (1.0 + zoomOffset))),
        },
        scale: this._panzoomScale * (1.0 + zoomOffset),
      });
    },
    panzoomShowRegion: function(rect, minimumZoom) {
      if (!('width' in rect)) {
        rect.width = rect.right - rect.left;
      }
      if (!('height' in rect)) {
        rect.height = rect.bottom - rect.top;
      }
    
      var rectCenter = {
        x: rect.left + (rect.width  / 2),
        y: rect.top  + (rect.height / 2),
      }
      var scaleToFit = null;
      if ((rect.width / rect.height) > (this.offsetWidth / this.offsetHeight)) {
        scaleToFit = this.offsetWidth / rect.width;
      } else {
        scaleToFit = this.offsetHeight / rect.height;
      }
      this.panzoom({
        translate: {
          x: -(rectCenter.x - (this.offsetWidth  / 2)),
          y: -(rectCenter.y - (this.offsetHeight / 2)),
        },
        scale: (minimumZoom !== undefined) ? Math.min(minimumZoom, scaleToFit) : scaleToFit,
      });
    },
    panzoomTransformPoint: function(point) {
      return {
        x: (point.x + this._panzoomTranslate.x) * this._panzoomScale,
        y: (point.y + this._panzoomTranslate.y) * this._panzoomScale,
      }
    },
    panzoomUntransformPoint: function(point) {
      return {
        x: (point.x / this._panzoomScale) - this._panzoomTranslate.x,
        y: (point.y / this._panzoomScale) - this._panzoomTranslate.y,
      }
    },
  }
</script>

<dom-module id="yb-panzoom">
  <template>
    <content></content>
  </template>
  
  <script>
    (function() {
      Polymer({
        is: 'yb-panzoom',
        behaviors: [window.Yarnball.PanzoomBehavior],
      });
    })();
  </script>
</dom-module>